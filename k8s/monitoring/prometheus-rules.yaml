apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  recording-rules.yml: |
    groups:
      - name: recording_rules
        interval: 30s
        rules:
          # Aggregate HTTP request rate
          - record: job:http_requests:rate5m
            expr: sum(rate(http_requests_total[5m])) by (job)
          # Request latency p95
          - record: job:http_request_duration_seconds:histogram_quantile95
            expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job))
          # Error rate
          - record: job:http_requests:error_rate5m
            expr: sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (job) / sum(rate(http_requests_total[5m])) by (job)

  alerting-rules.yml: |
    groups:
      - name: critical
        rules:
          - alert: InstanceDown
            expr: up == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Instance {{ $labels.instance }} down"
              description: "{{ $labels.job }} has been down for more than 5 minutes."

          - alert: AfriMartBackendDown
            expr: up{job="afrimart-backend"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "AfriMart backend is down"
              description: "Backend has not been reachable for 2 minutes."

          - alert: DatabaseConnectionFailed
            expr: rate(http_requests_total{job="afrimart-backend", status_code="500"}[5m]) > 0.1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High 5xx error rate on backend"
              description: "Backend may be failing to connect to database or Redis."

      - name: warning
        rules:
          - alert: HighCPU
            expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU on {{ $labels.instance }}"
              description: "CPU usage above 80% for 5 minutes."

          - alert: HighMemory
            expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory on {{ $labels.instance }}"
              description: "Memory usage above 85% for 5 minutes."

          - alert: HighErrorRate
            expr: (sum(rate(http_requests_total{status_code=~"5.."}[5m])) by (job) / sum(rate(http_requests_total[5m])) by (job)) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High error rate for {{ $labels.job }}"
              description: "5xx error rate above 5% for 5 minutes."

          - alert: HighLatency
            expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency for {{ $labels.job }}"
              description: "95th percentile latency above 2 seconds."
